<!-- sections/recent-slider.liquid -->
{% comment %}
  Slider of recently viewed products.

  Globals:
  - layout_horizontal: {string} Horizontal margin from global theme settings.
  - layout_gap_size: {integer} Set the gap between grid items.
  - enable_animations: {boolean} Global setting to determine if animations are enabled.
{% endcomment %}

{% comment %} Check if approved customer {% endcomment %}
{% liquid
  assign is_approved_customer = false
  if customer and settings.account_matching_tags == blank
    assign is_approved_customer = true
  endif
  if customer.tags contains settings.account_matching_tags
    assign is_approved_customer = true
  endif
  if settings.account_match_b2b and customer.b2b?
    assign is_approved_customer = true
  endif
%}

{% comment %} Card width snippet {% endcomment %}
{% capture card_width %}
  {% if section.settings.card_width_desktop == 12 %}
    md:w-full
  {% else %}
    md:w-{{ section.settings.card_width_desktop }}/12
  {% endif %}
 {% if section.settings.card_width_mobile == 12 %}
    w-full
  {% else %}
    w-{{ section.settings.card_width_mobile }}/12
  {% endif %} 
{% endcapture %}

<section
  id="{{ section.id }}"
  class="
    animation-1000
    {{ section.settings.visibility }}
    {{ section.settings.color_border }}
    {{ section.settings.style_border }}
    {{ section.settings.color_scheme }}
  "
>
  <div
    class="
      {% if section.settings.enable_margin %}
        {{ settings.x_margin }} !px-0
      {% endif %}
    "
    style="
      padding-top:{{ section.settings.spacing_top }}px;
      padding-bottom:{{ section.settings.spacing_bottom }}px;
    "
    x-data="
      {
        loadingRecent: true,
        setLoading() {
          setTimeout(function(){ this.loadingRecent = false}, 500);
        }
      }
    "
    x-show="recent_products.length > 0"
    x-init="setLoading();"
  >
    <div
      class="
        flex flex-wrap items-start justify-between
        {% if section.settings.enable_split %}
          flex-row
        {% else %}
          flex-col
        {% endif %}
      "
    >
      {% comment %} Header {% endcomment %}
      <div
        class="
          flex w-full flex-col px-4
          {% if section.settings.enable_split %}
            md:w-1/3 md:pr-4 md:sticky md:top-4 md:self-start
          {% endif %}
        "
      >
        {% render 'component__section-header' %}
      </div>

      {% comment %} Loading placeholder {% endcomment %}
      <div
        class="
          flex w-full
          {% if section.settings.enable_split %}md:w-2/3{% endif %}
        "
        x-show="!loadingRecent"
      >
        <div
          class="relative flex w-full flex-wrap"
          x-data="
            {

              index: 0, // the current active slide
              show_arrows: false, // hide arrows by default

              // check if slider extends width
              isOverflown(element) {
                return element.scrollWidth > element.clientWidth;
              },

              // scroll to a specific item
              scrollToIndex(indexToScroll) {
                this.index = indexToScroll;
                let slider = this.$refs.slider;
                let currentSlide = slider.querySelector('[data-slide=&quot;' + indexToScroll + '&quot;]');
                if (currentSlide) {
                  let sliderWidth = slider.offsetWidth;
                  let currentSlidePosition = currentSlide.offsetLeft;
                  let currentSlideWidth = currentSlide.offsetWidth;
                  let centerPosition = currentSlidePosition + currentSlideWidth / 2 - sliderWidth / 2;

                  slider.scrollTo({
                    top: 0,
                    left: centerPosition,
                    behavior: 'smooth'
                  });
                }
              },

              // scroll to next item
              scrollNext() {
                let slider = this.$refs.slider;
                let nextScrollPosition = slider.scrollLeft + slider.clientWidth;
                if (nextScrollPosition >= slider.scrollWidth - 20) {
                  nextScrollPosition = 0;
                }
                slider.scrollTo({
                  top: 0,
                  left: nextScrollPosition,
                  behavior: 'smooth'
                });
              },

              // scroll to previous item
              scrollBack() {
                let slider = this.$refs.slider;
                let previousScrollPosition = slider.scrollLeft - slider.clientWidth;
                if (slider.scrollLeft <= 20) {
                  previousScrollPosition = slider.scrollWidth - slider.clientWidth;
                }
                slider.scrollTo({
                  top: 0,
                  left: previousScrollPosition,
                  behavior: 'smooth'
                });
              }

            }
          "
        >
          <div
            class="window--max-full group relative flex w-full flex-col"
            :class="
              {
                'lg:window--max-fullmenuclamp' : menu_sidebar,
                {% if settings.cart_drawer_style == 'fixed' %}
                  'lg:window--max-fullcartclamp' : cart_drawer
                {% endif %}
              }
            "
          >
            <div
              class="hidescrollbar inline-flex w-full snap-x snap-mandatory overflow-x-auto overflow-y-hidden scroll-smooth whitespace-nowrap px-4"
              style="
                gap: {{ settings.gap_size }}px;
                padding-top: {{ settings.border_element_width }}px;
                scroll-padding: {{ settings.border_element_width }}px;
              "
              x-ref="slider"
              x-init="
                setTimeout(function(){
                  if (isOverflown($el)) show_arrows = true
                }, 600);
              "
            >
              <div
                class="
                  flex flex-none snap-center justify-center
                  {{ card_width }}
                "
              >
                {% render 'component__skeleton-grid' %}
              </div>
              <div
                class="
                  flex flex-none snap-center justify-center
                  {{ card_width }}
                "
              >
                {% render 'component__skeleton-grid' %}
              </div>
              <div
                class="
                  flex flex-none snap-center justify-center
                  {{ card_width }}
                "
              >
                {% render 'component__skeleton-grid' %}
              </div>
            </div>
          </div>
        </div>
      </div>

      {% comment %} Results {% endcomment %}
      <div
        class="
          flex w-full
          {% if section.settings.enable_split %}md:w-2/3{% endif %}
        "
        x-show="recent_products.length > 0 && loadingRecent"
        x-cloak
      >
        <div
          class="relative flex w-full flex-wrap"
          x-data="
            {

              index: 0, // the current active slide
              show_arrows: false, // hide arrows by default

              // check if slider extends width
              isOverflown(element) {
                return element.scrollWidth > element.clientWidth;
              },

              // scroll to a specific item
              scrollToIndex(indexToScroll) {
                this.index = indexToScroll;
                let slider = this.$refs.slider;
                let currentSlide = slider.querySelector('[data-slide=&quot;' + indexToScroll + '&quot;]');
                if (currentSlide) {
                  let sliderWidth = slider.offsetWidth;
                  let currentSlidePosition = currentSlide.offsetLeft;
                  let currentSlideWidth = currentSlide.offsetWidth;
                  let centerPosition = currentSlidePosition + currentSlideWidth / 2 - sliderWidth / 2;

                  slider.scrollTo({
                    top: 0,
                    left: centerPosition,
                    behavior: 'smooth'
                  });
                }
              },

              // scroll to next item
              scrollNext() {
                let slider = this.$refs.slider;
                let nextScrollPosition = slider.scrollLeft + slider.clientWidth;
                if (nextScrollPosition >= slider.scrollWidth - 20) {
                  nextScrollPosition = 0;
                }
                slider.scrollTo({
                  top: 0,
                  left: nextScrollPosition,
                  behavior: 'smooth'
                });
              },

              // scroll to previous item
              scrollBack() {
                let slider = this.$refs.slider;
                let previousScrollPosition = slider.scrollLeft - slider.clientWidth;
                if (slider.scrollLeft <= 20) {
                  previousScrollPosition = slider.scrollWidth - slider.clientWidth;
                }
                slider.scrollTo({
                  top: 0,
                  left: previousScrollPosition,
                  behavior: 'smooth'
                });
              }

            }
          "
        >
          <div
            class="window--max-full group relative flex w-full flex-col"
            :class="
              {
                'lg:window--max-fullmenuclamp' : menu_sidebar,
                {% if settings.cart_drawer_style == 'fixed' %}
                  'lg:window--max-fullcartclamp' : cart_drawer
                {% endif %}
              }
            "
          >
            {% comment %} Slides {% endcomment %}
            <div
              class="hidescrollbar inline-flex w-full snap-x snap-mandatory overflow-x-auto overflow-y-hidden scroll-smooth whitespace-nowrap px-4"
              style="
                gap: {{ settings.gap_size }}px;
                padding-top: {{ settings.border_element_width }}px;
                scroll-padding: {{ settings.border_element_width }}px;
              "
              x-ref="slider"
              x-init="
                setTimeout(function(){
                  if (isOverflown($el)) show_arrows = true
                }, 600);
              "
            >
              <template x-for="(item, index) in recent_products">
                <div
                  class="
                    flex flex-none snap-center justify-center
                    {{ card_width }}
                  "
                  {% if is_approved_customer == false %}
                    x-show="!item.tags.includes('{{ settings.account_hide_product_tag }}')"
                  {% endif %}
                  x-bind:data-slide="index"
                  x-intersect:enter.half="index = index;"
                >
                  {% render 'template__product-grid' %}
                </div>
              </template>
            </div>

            {% comment %} Arrows {% endcomment %}
            <div
              class="
                animation-300 absolute left-0 right-0 top-full z-10 flex w-full justify-end gap-2 pt-4
                {% if section.settings.enable_margin %}
                  {{ settings.x_margin }}
                {% else %}
                  window--full
                {% endif %}
              "
              x-show="show_arrows"
              x-cloak
            >
              <div>
                <button
                  class="btn btn--plain btn--smaller cursor-w-resize !p-2"
                  style="cursor: w-resize;"
                  title="{{ 'actions.previous' | t }}"
                  type="button"
                  {% if settings.enable_animations %}
                    x-transition:enter="animation-300"
                    x-transition:enter-start="opacity-0"
                    x-transition:enter-end="opacity-100"
                    x-transition:leave="animation-300"
                    x-transition:leave-start="opacity-100"
                    x-transition:leave-end="opacity-0"
                  {% endif %}
                  @click="scrollBack();"
                >
                  {% render 'component__icon', icon: 'chevron-left', size: '16', class: '' %}
                </button>
              </div>
              <div>
                <button
                  class="btn btn--plain btn--smaller cursor-e-resize !p-2"
                  style="cursor: e-resize;"
                  title="{{ 'actions.next' | t }}"
                  type="button"
                  {% if settings.enable_animations %}
                    x-transition:enter="animation-300"
                    x-transition:enter-start="opacity-0"
                    x-transition:enter-end="opacity-100"
                    x-transition:leave="animation-300"
                    x-transition:leave-start="opacity-100"
                    x-transition:leave-end="opacity-0"
                  {% endif %}
                  @click="scrollNext();"
                >
                  {% render 'component__icon', icon: 'chevron-right', size: '16', class: '' %}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "t:sections.recent_slider.name",
  "settings": [
    {
      "type": "header",
      "content": "t:general.headers.content.content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "t:general.settings.heading.label",
      "default": "t:general.defaults.recently_viewed"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "t:general.settings.content.label"
    },
    {
      "type": "header",
      "content": "t:general.headers.spacing.content"
    },
    {
      "type": "range",
      "id": "spacing_top",
      "min": 0,
      "max": 300,
      "step": 10,
      "unit": "px",
      "label": "t:general.settings.top_spacing.label",
      "default": 100
    },
    {
      "type": "range",
      "id": "spacing_bottom",
      "min": 0,
      "max": 300,
      "step": 10,
      "unit": "px",
      "label": "t:general.settings.bottom_spacing.label",
      "default": 100
    },
    {
      "type": "header",
      "content": "t:general.headers.color.content"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "t:general.settings.color_scheme.label",
      "options": [
        {
          "value": "color__bg-body color__text",
          "label": "t:general.settings.color_scheme.body.label"
        },
        {
          "value": "color__bg-neutral color__neutral",
          "label": "t:general.settings.color_scheme.neutral.label"
        },
        {
          "value": "color__bg-overlay-1 color__text",
          "label": "t:general.settings.color_scheme.accent_1.label"
        },
        {
          "value": "color__bg-overlay-2 color__text",
          "label": "t:general.settings.color_scheme.accent_2.label"
        },
        {
          "value": "color__bg-overlay-3 color__text",
          "label": "t:general.settings.color_scheme.accent_3.label"
        },
        {
          "value": "color__bg-shade-1 color__text",
          "label": "t:general.settings.color_scheme.shade_1.label"
        },
        {
          "value": "color__bg-shade-2 color__text",
          "label": "t:general.settings.color_scheme.shade_2.label"
        },
        {
          "value": "color__bg-shade-3 color__text",
          "label": "t:general.settings.color_scheme.shade_3.label"
        },
        {
          "value": "color__bg-primary color__primary",
          "label": "t:general.settings.color_scheme.primary.label"
        },
        {
          "value": "color__bg-secondary color__secondary",
          "label": "t:general.settings.color_scheme.secondary.label"
        },
        {
          "value": "color__bg-tertiary color__tertiary",
          "label": "t:general.settings.color_scheme.tertiary.label"
        }
      ],
      "default": "color__bg-body color__text"
    },
    {
      "type": "select",
      "id": "color_border",
      "label": "t:general.settings.color_border.label",
      "options": [
        {
          "value": "color__border-divider-1",
          "label": "t:general.settings.color_border.subtle.label"
        },
        {
          "value": "color__border-selected-1",
          "label": "t:general.settings.color_border.strong.label"
        }
      ],
      "default": "color__border-divider-1"
    },
    {
      "type": "header",
      "content": "t:general.headers.style.content"
    },
    {
      "type": "select",
      "id": "style_border",
      "label": "t:general.settings.border_position.label",
      "options": [
        {
          "value": "",
          "label": "t:general.settings.border_position.none.label"
        },
        {
          "value": "border--t-width",
          "label": "t:general.settings.border_position.top.label"
        },
        {
          "value": "border--b-width",
          "label": "t:general.settings.border_position.bottom.label"
        },
        {
          "value": "border--b-width border--t-width",
          "label": "t:general.settings.border_position.top_and_bottom.label"
        }
      ],
      "default": "border--b-width"
    },
    {
      "type": "header",
      "content": "t:general.headers.layout.content"
    },
    {
      "type": "range",
      "id": "card_width_mobile",
      "min": 6,
      "max": 12,
      "step": 1,
      "unit": "/12",
      "label": "t:general.settings.card_width_mobile.label",
      "default": 8
    },
    {
      "type": "range",
      "id": "card_width_desktop",
      "min": 1,
      "max": 12,
      "step": 1,
      "unit": "/12",
      "label": "t:general.settings.card_width_desktop.label",
      "default": 3
    },
    {
      "type": "select",
      "id": "layout_x_alignment",
      "label": "t:general.settings.x_alignment.label",
      "options": [
        {
          "value": "justify-between",
          "label": "t:general.settings.x_alignment.left.label"
        },
        {
          "value": "text-center justify-center flex-col items-center",
          "label": "t:general.settings.x_alignment.center.label"
        }
      ],
      "default": "justify-between"
    },
    {
      "type": "checkbox",
      "id": "enable_margin",
      "label": "t:general.settings.enable_margin.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_split",
      "label": "t:general.settings.enable_split.label",
      "default": false
    },
    {
      "type": "header",
      "content": "t:general.headers.display.content"
    },
    {
      "type": "select",
      "id": "visibility",
      "label": "t:general.settings.visibility.label",
      "options": [
        {
          "value": "",
          "label": "t:general.settings.visibility.all.label"
        },
        {
          "value": "md:hidden",
          "label": "t:general.settings.visibility.mobile.label"
        },
        {
          "value": "hidden md:block",
          "label": "t:general.settings.visibility.desktop.label"
        }
      ],
      "default": ""
    }
  ],
  "presets": [
    {
      "name": "t:sections.recent_slider.name"
    }
  ],
  "disabled_on": {
    "groups": ["header", "custom.overlay"]
  }
}
{% endschema %}
