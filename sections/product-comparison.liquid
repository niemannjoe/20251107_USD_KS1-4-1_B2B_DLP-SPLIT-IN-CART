<!-- sections/product-comparison.liquid -->
{% comment %}
  A table displaying multiple products side by side.

  Globals:
  - layout_horizontal: {string} Class string to set horizontal margin.

  Recommendations:
  - Can be used to display different products side by side.
{% endcomment %}

{% liquid
  assign is_approved_customer = false
  if customer and settings.account_matching_tags == blank
    assign is_approved_customer = true
  endif
  if customer.tags contains settings.account_matching_tags
    assign is_approved_customer = true
  endif
  if settings.account_match_b2b and customer.b2b?
    assign is_approved_customer = true
  endif
%}

<section
  id="{{ section.id }}"
  class="
    animation-1000
    {{ section.settings.visibility }}
    {{ section.settings.color_border }}
    {{ section.settings.style_border }}
    {{ section.settings.color_scheme }}
  "
>
  <div
    class="
      {% if section.settings.enable_margin %}
        {{ settings.x_margin }} !px-0
      {% endif %}
    "
    style="
      padding-top:{{ section.settings.spacing_top }}px;
      padding-bottom:{{ section.settings.spacing_bottom }}px;
    "
  >
    <div
      class="
        flex flex-wrap items-start justify-between
        {% if section.settings.enable_split %}
          flex-row
        {% else %}
          flex-col
        {% endif %}
      "
    >
      {% comment %} Header {% endcomment %}
      <div
        class="
          flex w-full flex-col px-4
          {% if section.settings.enable_split %}
            md:w-1/3 md:pr-4 md:sticky md:top-4 md:self-start
          {% endif %}
        "
      >
        {% render 'component__section-header' %}
      </div>

      {% comment %} Content {% endcomment %}
      <div
        class="
          window--max-full w-full
          {% if section.settings.enable_split %}md:w-2/3{% endif %}
        "
        :class="
          {
            'lg:window--max-fullmenuclamp' : menu_sidebar,
            {% if settings.cart_drawer_style == 'fixed' %}
              'lg:window--max-fullcartclamp' : cart_drawer
            {% endif %}
          }
        "
      >
        {% comment %} Columns container with horizontal scroll {% endcomment %}
        <div
          class="
            showscrollbar inline-flex w-full items-stretch gap-4 overflow-x-auto overflow-y-hidden scroll-smooth whitespace-nowrap md:snap-x md:snap-mandatory
            {% if section.settings.layout_x_alignment contains 'center' %}
              md:justify-center
            {% endif %}
            {% if section.settings.layout_x_alignment contains 'end' %}
              md:justify-end
            {% endif %}
          "
          style="
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: {{ settings.border_element_width }}px;
            scroll-padding: {{ settings.border_element_width }}px;
          "
          x-data="{ row: 0 }"
        >
          {% comment %} Show placeholder in design mode {% endcomment %}
          {% if request.design_mode and section.settings.product.count == 0 %}
            {% for product in collections.all.products limit: 6 %}
              <div class="flex w-4/5 flex-none flex-col justify-start md:w-2/5 lg:w-1/5">
                {% comment %} Product image {% endcomment %}
                <div class="aspect-h-1 aspect-w-1 w-full overflow-clip">
                  {% render 'component__image',
                    image: product.featured_image,
                    max_width: 600,
                    background_class: '',
                    image_class: 'w-full h-full',
                    ratio_class: 'aspect-[1/1] aspect-w-1 aspect-h-1',
                    crop_class: 'object-cover',
                    enable_lazy_load: true,
                    enable_2x: true
                  %}
                </div>

                {% comment %} Product title and button {% endcomment %}
                <div class="border--b-width color__border-divider-1 flex flex-col items-start gap-2 whitespace-normal py-4">
                  <div class="flex flex-1 flex-col">
                    <h3 class="type__body type--base">{{ product.title }}</h3>
                  </div>
                  <a href="{{ product.url }}" class="btn btn--secondary btn--smaller mt-auto !w-auto">View details</a>
                </div>

                {% comment %} Comparison data rows {% endcomment %}
                <div
                  class="flex h-full flex-col"
                >
                  {% for block in section.blocks %}
                    {% case block.type %}
                      {% when 'price' %}
                        {% capture price %}
                          <div
                            class="type--smaller flex whitespace-normal py-2"
                            :class="{ 'color__bg-shade-1': row == {{ forloop.index }} }"
                            @mouseover="row = {{ forloop.index }}"
                          >
                            <div>
                              {% comment %} Starting price {% endcomment %}
                              <span>
                                {% if product.price_varies and settings.price_range == 'show_starting_price' %}
                                  <span>
                                    {{ 'labels.from' | t }}
                                  </span>
                                {% endif %}
                                {% render 'component__format-price', price: product.price_min %}
                              </span>
            
                              {% comment %} If showing range {% endcomment %}
                              {% if product.price_varies and settings.price_range == 'show_range' %}
                                <span>
                                  -
                                  {% render 'component__format-price', price: product.price_max %}
                                </span>
                              {% endif %}
            
                              {% comment %} Sale price {% endcomment %}
                              {% if product.compare_at_price_max > 0 %}
                                <span class="opacity-50">
                                  <s>
                                    {% render 'component__format-price', price: product.compare_at_price_max %}
                                  </s>
                                </span>
                              {% endif %}
                            </div>
                          </div>
                        {% endcapture %}
                        {% if is_approved_customer == true %}
                          {{ price }}
                        {% else %}
                          {% unless product.tags contains settings.account_hide_price_tag %}
                            {{ price }}
                          {% endunless %}
                        {% endif %}

                      {% when 'rating' %}
                        <div
                          class="flex whitespace-normal py-2"
                          :class="{ 'color__bg-shade-1': row == {{ forloop.index }} }"
                          @mouseover="row = {{ forloop.index }}"
                        >
                          {% render 'component__rating',
                            product: product,
                            enable_stars: true,
                            enable_badge: false,
                            enable_empty: true
                          %}
                        </div>

                      {% when 'stock' %}
                        {% assign product_qty = 0 %}
                        {% for variant in product.variants %}
                          {% if variant.inventory_quantity > 0 %}
                            {% assign product_qty = product_qty | plus: variant.inventory_quantity %}
                          {% endif %}
                        {% endfor %}
                        <div
                          class="flex flex-col whitespace-normal py-2"
                          :class="{ 'color__bg-shade-1': row == {{ forloop.index }} }"
                          @mouseover="row = {{ forloop.index }}"
                        >
                          <p class="type--smaller">
                            {{ product_qty }}
                            {{ 'info.in_stock' | t | downcase }}
                          </p>
                        </div>

                      {% when 'type' %}
                        <div
                          class="flex flex-col whitespace-normal py-2"
                          :class="{ 'color__bg-shade-1': row == {{ forloop.index }} }"
                          @mouseover="row = {{ forloop.index }}"
                        >
                          <strong class="type--smaller">{{ 'labels.type' | t }}:</strong>
                          <p class="type--smaller">
                            {{ product.type | default: '-' }}
                          </p>
                        </div>

                      {% when 'metafield' %}
                        <div
                          class="flex flex-col whitespace-normal py-2"
                          :class="{ 'color__bg-shade-1': row == {{ forloop.index }} }"
                          @mouseover="row = {{ forloop.index }}"
                        >
                          <strong class="type--smaller">{{ block.settings.label }}:</strong>
                          {% if block.settings.product_metafields %}
                            {% assign all_metafields = block.settings.product_metafields | split: ',' %}
                            {% for metafield_string in all_metafields %}
                              {% assign metafield_parts = metafield_string | strip | split: '.' %}
                              {% if metafield_parts.size == 2 %}
                                {% assign namespace = metafield_parts[0] | strip %}
                                {% assign key = metafield_parts[1] | strip %}
                                <p class="type--smaller">
                                  {{ product.metafields[namespace][key].value | default: '-' }}
                                </p>
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                        </div>
                    {% endcase %}
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          {% endif %}

          {% comment %} Product columns {% endcomment %}
          {% for product in section.settings.product %}
            <div class="flex w-4/5 flex-none flex-col justify-start md:w-2/5 lg:w-1/5">
              {% comment %} Product image {% endcomment %}
              <div class="aspect-h-1 aspect-w-1 w-full overflow-clip">
                {% render 'component__image',
                  image: product.featured_image,
                  max_width: 600,
                  background_class: '',
                  image_class: 'w-full h-full',
                  ratio_class: 'aspect-[1/1] aspect-w-1 aspect-h-1',
                  crop_class: 'object-cover',
                  enable_lazy_load: true,
                  enable_2x: true
                %}
              </div>

              {% comment %} Product title and button {% endcomment %}
              <div class="border--b-width color__border-divider-1 flex flex-col items-start gap-2 whitespace-normal py-4">
                <div class="flex flex-1 flex-col">
                  <h3 class="type__body type--base">{{ product.title }}</h3>
                </div>
                <a href="{{ product.url }}" class="btn btn--secondary btn--smaller mt-auto !w-auto">View details</a>
              </div>

              {% comment %} Comparison data rows {% endcomment %}
              <div
                class="flex h-full flex-col"
              >
                {% for block in section.blocks %}
                  {% case block.type %}
                    {% when 'price' %}
                      {% capture price %}
                        <div
                          class="type--smaller flex whitespace-normal py-2"
                          :class="{ 'color__bg-shade-1': row == {{ forloop.index }} }"
                          @mouseover="row = {{ forloop.index }}"
                        >
                          <div>
                            {% comment %} Starting price {% endcomment %}
                            <span>
                              {% if product.price_varies and settings.price_range == 'show_starting_price' %}
                                <span>
                                  {{ 'labels.from' | t }}
                                </span>
                              {% endif %}
                              {% render 'component__format-price', price: product.price_min %}
                            </span>
          
                            {% comment %} If showing range {% endcomment %}
                            {% if product.price_varies and settings.price_range == 'show_range' %}
                              <span>
                                -
                                {% render 'component__format-price', price: product.price_max %}
                              </span>
                            {% endif %}
          
                            {% comment %} Sale price {% endcomment %}
                            {% if product.compare_at_price_max > 0 %}
                              <span class="opacity-50">
                                <s>
                                  {% render 'component__format-price', price: product.compare_at_price_max %}
                                </s>
                              </span>
                            {% endif %}
                          </div>
                        </div>
                      {% endcapture %}
                      {% if is_approved_customer == true %}
                        {{ price }}
                      {% else %}
                        {% unless product.tags contains settings.account_hide_price_tag %}
                          {{ price }}
                        {% endunless %}
                      {% endif %}

                    {% when 'rating' %}
                      <div
                        class="flex whitespace-normal py-2"
                        :class="{ 'color__bg-shade-1': row == {{ forloop.index }} }"
                        @mouseover="row = {{ forloop.index }}"
                      >
                        {% render 'component__rating',
                          product: product,
                          enable_stars: true,
                          enable_badge: false,
                          enable_empty: true
                        %}
                      </div>

                    {% when 'stock' %}
                      {% assign product_qty = 0 %}
                      {% for variant in product.variants %}
                        {% if variant.inventory_quantity > 0 %}
                          {% assign product_qty = product_qty | plus: variant.inventory_quantity %}
                        {% endif %}
                      {% endfor %}
                      <div
                        class="flex flex-col whitespace-normal py-2"
                        :class="{ 'color__bg-shade-1': row == {{ forloop.index }} }"
                        @mouseover="row = {{ forloop.index }}"
                      >
                        <p class="type--smaller">
                          {{ product_qty }}
                          {{ 'info.in_stock' | t | downcase }}
                        </p>
                      </div>

                    {% when 'type' %}
                      <div
                        class="flex flex-col whitespace-normal py-2"
                        :class="{ 'color__bg-shade-1': row == {{ forloop.index }} }"
                        @mouseover="row = {{ forloop.index }}"
                      >
                        <strong class="type--smaller">{{ 'labels.type' | t }}:</strong>
                        <p class="type--smaller">
                          {{ product.type | default: '-' }}
                        </p>
                      </div>

                    {% when 'metafield' %}
                      <div
                        class="flex flex-col whitespace-normal py-2"
                        :class="{ 'color__bg-shade-1': row == {{ forloop.index }} }"
                        @mouseover="row = {{ forloop.index }}"
                      >
                        <strong class="type--smaller">{{ block.settings.label }}:</strong>
                        {% if block.settings.product_metafields %}
                          {% assign all_metafields = block.settings.product_metafields | split: ',' %}
                          {% for metafield_string in all_metafields %}
                            {% assign metafield_parts = metafield_string | strip | split: '.' %}
                            {% if metafield_parts.size == 2 %}
                              {% assign namespace = metafield_parts[0] | strip %}
                              {% assign key = metafield_parts[1] | strip %}
                              <p class="type--smaller">
                                {{ product.metafields[namespace][key].value | default: '-' }}
                              </p>
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                      </div>
                  {% endcase %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "t:sections.product_comparison.name",
  "settings": [
    {
      "type": "product_list",
      "id": "product",
      "label": "t:general.settings.product.label",
      "limit": 5
    },
    {
      "type": "header",
      "content": "t:general.headers.content.content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "t:general.settings.heading.label"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "t:general.settings.content.label"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "t:general.settings.button_label.label"
    },
    {
      "type": "url",
      "id": "button_url",
      "label": "t:general.settings.button_url.label"
    },
    {
      "type": "header",
      "content": "t:general.headers.spacing.content"
    },
    {
      "type": "range",
      "id": "spacing_top",
      "min": 0,
      "max": 300,
      "step": 10,
      "unit": "px",
      "label": "t:general.settings.top_spacing.label",
      "default": 100
    },
    {
      "type": "range",
      "id": "spacing_bottom",
      "min": 0,
      "max": 300,
      "step": 10,
      "unit": "px",
      "label": "t:general.settings.bottom_spacing.label",
      "default": 100
    },
    {
      "type": "header",
      "content": "t:general.headers.color.content"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "t:general.settings.color_scheme.label",
      "options": [
        {
          "value": "color__bg-body color__text",
          "label": "t:general.settings.color_scheme.body.label"
        },
        {
          "value": "color__bg-neutral color__neutral",
          "label": "t:general.settings.color_scheme.neutral.label"
        },
        {
          "value": "color__bg-overlay-1 color__text",
          "label": "t:general.settings.color_scheme.accent_1.label"
        },
        {
          "value": "color__bg-overlay-2 color__text",
          "label": "t:general.settings.color_scheme.accent_2.label"
        },
        {
          "value": "color__bg-overlay-3 color__text",
          "label": "t:general.settings.color_scheme.accent_3.label"
        },
        {
          "value": "color__bg-shade-1 color__text",
          "label": "t:general.settings.color_scheme.shade_1.label"
        },
        {
          "value": "color__bg-shade-2 color__text",
          "label": "t:general.settings.color_scheme.shade_2.label"
        },
        {
          "value": "color__bg-shade-3 color__text",
          "label": "t:general.settings.color_scheme.shade_3.label"
        },
        {
          "value": "color__bg-primary color__primary",
          "label": "t:general.settings.color_scheme.primary.label"
        },
        {
          "value": "color__bg-secondary color__secondary",
          "label": "t:general.settings.color_scheme.secondary.label"
        },
        {
          "value": "color__bg-tertiary color__tertiary",
          "label": "t:general.settings.color_scheme.tertiary.label"
        }
      ],
      "default": "color__bg-body color__text"
    },
    {
      "type": "select",
      "id": "color_border",
      "label": "t:general.settings.color_border.label",
      "options": [
        {
          "value": "color__border-divider-1",
          "label": "t:general.settings.color_border.subtle.label"
        },
        {
          "value": "color__border-selected-1",
          "label": "t:general.settings.color_border.strong.label"
        }
      ],
      "default": "color__border-divider-1"
    },
    {
      "type": "select",
      "id": "color_button",
      "label": "t:general.settings.color_button.label",
      "options": [
        {
          "value": "btn",
          "label": "t:general.settings.color_button.primary.label"
        },
        {
          "value": "btn btn--secondary",
          "label": "t:general.settings.color_button.secondary.label"
        },
        {
          "value": "btn btn--tertiary",
          "label": "t:general.settings.color_button.tertiary.label"
        },
        {
          "value": "btn btn--neutral",
          "label": "t:general.settings.color_button.neutral.label"
        },
        {
          "value": "btn btn--plain",
          "label": "t:general.settings.color_button.plain.label"
        },
        {
          "value": "btn btn--outline",
          "label": "t:general.settings.color_button.outline.label"
        },
        {
          "value": "btn btn--outline-alt",
          "label": "t:general.settings.color_button.inverted_outline.label"
        },
        {
          "value": "btn btn--minimal",
          "label": "t:general.settings.color_button.link.label"
        },
        {
          "value": "btn btn--minimal-alt",
          "label": "t:general.settings.color_button.inverted_link.label"
        }
      ],
      "default": "btn btn--secondary"
    },
    {
      "type": "header",
      "content": "t:general.headers.style.content"
    },
    {
      "type": "select",
      "id": "heading_font",
      "label": "t:general.settings.title_font.label",
      "options": [
        {
          "value": "type__body type--base",
          "label": "t:general.settings.font_family.standard.label"
        },
        {
          "value": "type__heading type__heading-1",
          "label": "t:general.settings.font_family.heading.label"
        },
        {
          "value": "type__nav type--base",
          "label": "t:general.settings.font_family.navigation.label"
        }
      ],
      "default": "type__body type--base"
    },
    {
      "type": "select",
      "id": "style_border",
      "label": "t:general.settings.border_position.label",
      "options": [
        {
          "value": "",
          "label": "t:general.settings.border_position.none.label"
        },
        {
          "value": "border--t-width",
          "label": "t:general.settings.border_position.top.label"
        },
        {
          "value": "border--b-width",
          "label": "t:general.settings.border_position.bottom.label"
        },
        {
          "value": "border--b-width border--t-width",
          "label": "t:general.settings.border_position.top_and_bottom.label"
        }
      ],
      "default": "border--b-width"
    },
    {
      "type": "header",
      "content": "t:general.headers.layout.content"
    },
    {
      "type": "select",
      "id": "layout_x_alignment",
      "label": "t:general.settings.x_alignment.label",
      "options": [
        {
          "value": "justify-between",
          "label": "t:general.settings.x_alignment.left.label"
        },
        {
          "value": "text-center justify-center flex-col items-center",
          "label": "t:general.settings.x_alignment.center.label"
        },
        {
          "value": "text-right justify-end flex-col items-end",
          "label": "t:general.settings.x_alignment.right.label"
        }
      ],
      "default": "justify-between"
    },
    {
      "type": "checkbox",
      "id": "enable_margin",
      "label": "t:general.settings.enable_margin.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_split",
      "label": "t:general.settings.enable_split.label",
      "default": false
    },
    {
      "type": "header",
      "content": "t:general.headers.display.content"
    },
    {
      "type": "select",
      "id": "visibility",
      "label": "t:general.settings.visibility.label",
      "options": [
        {
          "value": "",
          "label": "t:general.settings.visibility.all.label"
        },
        {
          "value": "md:hidden",
          "label": "t:general.settings.visibility.mobile.label"
        },
        {
          "value": "hidden md:block",
          "label": "t:general.settings.visibility.desktop.label"
        }
      ],
      "default": ""
    }
  ],
  "blocks": [
    {
      "type": "price",
      "name": "t:sections.product_comparison.blocks.price.name",
      "limit": 1
    },
    {
      "type": "rating",
      "name": "t:sections.product_comparison.blocks.rating.name",
      "limit": 1
    },
    {
      "type": "stock",
      "name": "t:sections.product_comparison.blocks.stock.name",
      "limit": 1
    },
    {
      "type": "type",
      "name": "t:sections.product_comparison.blocks.type.name",
      "limit": 1
    },
    {
      "type": "metafield",
      "name": "t:sections.product_comparison.blocks.metafield.name",
      "limit": 20,
      "settings": [
        {
          "type": "header",
          "content": "t:general.headers.content.content"
        },
        {
          "type": "text",
          "id": "label",
          "label": "t:general.settings.label.label"
        },
        {
          "type": "text",
          "id": "product_metafields",
          "label": "t:general.settings.product_metafields.label",
          "info": "t:general.settings.product_metafields.info"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.product_comparison.name",
      "settings": {
        "heading": "Product comparison",
        "content": "",
        "button_label": "",
        "button_url": "",
        "spacing_top": 100,
        "spacing_bottom": 100,
        "color_scheme": "color__bg-body",
        "color_border": "color__border-divider-1",
        "color_button": "btn btn--secondary",
        "heading_font": "type__body type--base",
        "style_border": "border--b-width",
        "layout_x_alignment": "justify-between",
        "enable_margin": true,
        "enable_split": false,
        "visibility": ""
      }
    }
  ],
  "disabled_on": {
    "groups": ["header", "custom.overlay"]
  }
}
{% endschema %}
