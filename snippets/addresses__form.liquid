<!-- snippets/addresses__form.liquid -->
{% comment %}
  This snippet is used to render a form for customer addresses on account pages. It accepts a unique id for the form, a URL to post to, and text for the submit button.

  Accepts:
  - id: {string} Unique id for the form.
  - action: {string} URL to post to.
  - cta: {string} Text for the submit button.

  Usage:
    {% render 'addresses__form',
      id: 'new',
      action: customer.new_address,
      cta: address_create_button
    %}

  Recommendations:
  - Use this snippet to render address forms on customer account pages.
  - Ensure the 'id' is unique to prevent conflicts with other elements on the page.
  - The 'action' should be a valid URL where the form data will be posted.
  - The 'cta' is the text that will be displayed on the submit button.
{% endcomment %}

{% liquid
  assign form_suffix = '_' | append: id
  assign form_country_id = 'country' | append: form_suffix
  assign form_province_container_id = 'provinceContainer' | append: form_suffix
  assign form_province_id = 'province' | append: form_suffix
  assign redirect_url = request.path | append: '?ad=2'
%}

<div
  id="form_{{id}}"
  class="relative w-full"
>
  {% assign form_id = section.id | append: '-address' %}
  {% form 'customer_address', action, id: form_id, return_to: redirect_url %}
    <div class="flex flex-col gap-4 p-4">
      <div class="w-full">
        <label
          class="block"
          for="{{ id }}_{{ form_suffix }}_first_name"
        >
          {{ 'labels.first_name' | t }}
        </label>
        <input
          id="{{ id }}_{{ form_suffix }}_first_name"
          class="w-full"
          type="text"
          name="address[first_name]"
          value="{{ form.first_name }}"
          placeholder="{{ 'actions.name_placeholder' | t }}"
          required
        >
      </div>

      <div class="w-full">
        <label
          class="block"
          for="{{ id }}_{{ form_suffix }}_last_name"
        >
          {{ 'labels.last_name' | t }}
        </label>
        <input
          id="{{ id }}_{{ form_suffix }}_last_name"
          class="w-full"
          type="text"
          name="address[last_name]"
          value="{{ form.last_name }}"
          placeholder="{{ 'actions.name_placeholder' | t }}"
          required
        >
      </div>

      <div class="w-full">
        <label
          class="block"
          for="{{ id }}_{{ form_suffix }}_company"
        >
          {{ 'labels.company' | t }}
        </label>
        <input
          id="{{ id }}_{{ form_suffix }}_company"
          class="w-full"
          type="text"
          name="address[company]"
          value="{{ form.company }}"
          placeholder="{{ 'labels.company' | t }}"
        >
      </div>

      <div class="w-full">
        <label
          class="block"
          for="{{ id }}_{{ form_suffix }}_phone"
        >
          {{ 'labels.phone' | t }}
        </label>
        <input
          id="{{ id }}_{{ form_suffix }}_phone"
          class="w-full"
          type="tel"
          name="address[phone]"
          value="{{ form.phone }}"
          placeholder="{{ 'labels.phone' | t }}"
        >
      </div>

      <div class="w-full">
        <label
          class="block"
          for="{{ id }}_{{ form_suffix }}_address1"
        >
          {{ 'labels.address1' | t }}
        </label>
        <input
          id="{{ id }}_{{ form_suffix }}_address1"
          class="w-full"
          type="text"
          name="address[address1]"
          value="{{ form.address1 }}"
          placeholder="{{ 'labels.address1' | t }}"
        >
      </div>

      <div class="w-full">
        <label
          class="block"
          for="{{ id }}_{{ form_suffix }}_address2"
        >
          {{ 'labels.address2' | t }}
        </label>
        <input
          id="{{ id }}_{{ form_suffix }}_address2"
          class="w-full"
          type="text"
          name="address[address2]"
          value="{{ form.address2 }}"
          placeholder="{{ 'labels.address2' | t }}"
        >
      </div>

      <div class="w-full">
        <label
          class="block"
          for="{{ id }}_{{ form_suffix }}_city"
        >
          {{ 'labels.city' | t }}
        </label>
        <input
          id="{{ id }}_{{ form_suffix }}_city"
          class="w-full"
          type="text"
          name="address[city]"
          value="{{ form.city }}"
          placeholder="{{ 'labels.city' | t }}"
        >
      </div>

      <div class="w-full">
        <label
          class="block"
          for="{{ id }}_{{ form_suffix }}_zip"
        >
          {{ 'labels.zip' | t }}
        </label>
        <input
          id="{{ id }}_{{ form_suffix }}_zip"
          class="w-full"
          type="text"
          name="address[zip]"
          value="{{ form.zip }}"
          placeholder="{{ 'labels.zip' | t }}"
        >
      </div>

      <div class="w-full">
        <label
          class="block"
          for="{{ form_country_id }}"
        >
          {{ 'labels.country' | t }}
        </label>
        <select
          id="{{ form_country_id }}"
          name="address[country]"
          value="{{ value }}"
          data-default="{{ form.country }}"
          data-product-select
          required
        >
          {% if placeholder %}
            <option disabled>{{ 'labels.country' | t }}</option>
          {% endif %}
          {{ country_option_tags }}
        </select>
      </div>

      <div
        id="{{ 'provinceContainer' | append: form_suffix }}"
        class="w-full"
      >
        <label
          class="block"
          for="{{ form_province_id }}"
        >
          {{ 'labels.region' | t }}
        </label>
        <select
          id="{{ form_province_id }}"
          name="address[province]"
          value="{{ value }}"
          data-default="{{ form.province }}"
          required
        >
          {% if placeholder %}
            <option disabled>{{ 'labels.region' | t }}</option>
          {% endif %}
        </select>
      </div>

      <label
        class="flex items-center"
      >
        {{ form.set_as_default_checkbox }}
        <span class="ml-2 inline-block">{{ 'actions.set_default_address' | t }}</span>
      </label>
    </div>

    <div class="color__bg-body color__text border--t-width color__border-divider-1 sticky bottom-0 flex w-full gap-4 p-4">
      <button
        class="btn"
        name=""
        type="submit"
        role="button"
      >
        {{ cta }}
      </button>
      <button
        class="btn btn--plain"
        name=""
        type="button"
        role="button"
        @click="
          popup = false;
          edit_address_drawer = false;
          new_address_drawer = false;
        "
      >
        {{ 'actions.cancel' | t }}
      </button>
    </div>
  {% endform %}

 <script>
    (function() {
      // Create a unique ID for this form instance to avoid conflicts
      const formInstanceId = "{{ form_suffix | replace: '-', '_' }}";

      // Initialize the address form
      function initializeAddressForm() {

        const countrySelector = document.getElementById({{ form_country_id | json }});
        const provinceSelector = document.getElementById({{ form_province_id | json }});
        const provinceContainer = document.getElementById({{ form_province_container_id | json }});

        // If elements don't exist yet, return false to indicate initialization failed
        if (!countrySelector) {
          return false;
        }

        if (!provinceSelector) {
          return false;
        }

        if (!provinceContainer) {
          return false;
        }


        const countryDefault = countrySelector.getAttribute('data-default') || '';
        const provinceDefault = provinceSelector.getAttribute('data-default') || '';


        // Hide province container by default
        provinceContainer.style.display = 'none';

        /**
         * Select an option within a <select> based on a given value
         */
        function selectOption(value, select) {
          if (!select || !select.options || select.options.length === 0) {
            return null;
          }

          for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].value === value) {
              select.selectedIndex = i;
              return select.options[i];
            }
          }

          return null;
        }

        /**
         * Generate province options and show select element
         */
        function showProvinces(options) {

          // Only rebuild options if they've changed
          const previousValue = provinceSelector.options[0] ? provinceSelector.options[0].value : false;
          const isNewValue = !previousValue || options[0][0] !== previousValue;

          if (isNewValue) {
            // Empty provinces select
            provinceSelector.innerHTML = '';

            // Generate new options from values
            for (let i = 0; i < options.length; i++) {
              const option = document.createElement('option');
              option.value = options[i][0];
              option.innerHTML = options[i][1];
              provinceSelector.appendChild(option);
            }
          }

          // Select the default province if available
          if (provinceDefault && provinceDefault.length > 0) {
            const selected = selectOption(provinceDefault, provinceSelector);
          }

          // Make province field required when provinces are shown
          provinceSelector.setAttribute('required', 'required');

          // Show provinces
          provinceContainer.style.display = 'block';
        }

        /**
         * Hide provinces container
         */
        function hideProvinces() {
          provinceContainer.style.display = 'none';
          provinceSelector.removeAttribute('required');
        }

        /**
         * Select default country and check for provinces
         */
        function selectDefaults() {

          if (!countryDefault || countryDefault.length === 0) {
            if (countrySelector.options.length > 0) {
              countrySelector.selectedIndex = 0;
              const selectedCountry = countrySelector.options[0];
              const options = getProvinceOptions(selectedCountry);
              if (options && options.length > 0) {
                showProvinces(options);
              } else {
                hideProvinces();
              }
            }
            return;
          }

          const selectedCountry = selectOption(countryDefault, countrySelector);
          if (selectedCountry) {
            const options = getProvinceOptions(selectedCountry);

            // Only show provinces if the country has provinces
            if (options && options.length > 0) {
              showProvinces(options);
            } else {
              hideProvinces();
            }
          } else {
          }
        }

        /**
         * Get province options from a country option element
         */
        function getProvinceOptions(countryOption) {
          if (!countryOption) return [];

          try {
            return JSON.parse(countryOption.getAttribute('data-provinces') || '[]');
          } catch (e) {
            return [];
          }
        }

        // Set up change event for country selector
        countrySelector.addEventListener('change', function() {

          if (this.selectedIndex < 0 || !this.options[this.selectedIndex]) {
            return;
          }

          const selectedCountry = this.options[this.selectedIndex];
          const options = getProvinceOptions(selectedCountry);

          if (options && options.length > 0) {
            showProvinces(options);
          } else {
            hideProvinces();
          }
        });

        // Initialize with default values
        selectDefaults();

        // Mark as initialized
        countrySelector.setAttribute('data-initialized', 'true');
        return true;
      }

      // Try to initialize immediately
      function attemptInitialization(retryCount = 0, maxRetries = 10) {
        if (retryCount >= maxRetries) {
          return;
        }

        if (!initializeAddressForm()) {
          // Retry with exponential backoff
          const delay = Math.min(100 * Math.pow(1.5, retryCount), 2000);

          setTimeout(() => {
            attemptInitialization(retryCount + 1, maxRetries);
          }, delay);
        }
      }

      // Run initialization when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          attemptInitialization();
        });
      } else {
        attemptInitialization();
      }

      // Watch for drawer opening events
      document.addEventListener('alpine:initialized', function() {

        // For Alpine.js drawers
        if (window.Alpine) {
          try {

            attemptInitialization();

            // Monitor for Alpine.js changes to the drawer state
            document.addEventListener('address-drawer-opened', function(e) {
              setTimeout(() => attemptInitialization(), 100);
            });

          } catch (e) {
          }
        }
      });
    })();
  </script>
</div>
