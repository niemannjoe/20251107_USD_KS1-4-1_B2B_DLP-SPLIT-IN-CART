<!-- snippets/template__product-grid.liquid -->
{% comment %}
  Product item that renders within Alpine template.

  Usage:
    {% render 'template__product-grid' %}

  Globals:
  - enable_animations: {boolean} Enables animations if set to true.
  - product_card_border_style: {string} Sets the border style of thumbnails.
  - product_card_color_border: {string} Sets the border color.
  - product_card_color_scheme: {string} Sets the color scheme of thumbnails.
  - product_card_ratio: {string} Sets the aspect ratio of thumbnails.
  - thumbnails_object: {string} Sets the image object sizing.
  - product_card_title_capitilization: {string} Sets the capitilization for thumbnail titles.
  - product_card_title_font: {string} Sets the font family for titles.
  - type_separator: {string} Sets the type of seperator between text.
  - product_card_savings_badge: {string} Can be set to 'dollar', 'percent', or 'none' to display savings badge.
  - product_card_stock_threshold: {number} Sets the threshold for when to show stock count.
  - enable_quick_desktop: {boolean} Enables quick add on desktop if set to true.
  - enable_quick_mobile: {boolean} Enables quick add on mobile if set to true.
  - product_card_enable_type: {boolean} Displays product type if set to true.
  - product_card_enable_vendor: {boolean} Displays vendor if set to true.
  - product_card_enable_count: {boolean} Displays variant count if set to true.

  Recommendations:
  - Must be used within a <template> tag with AlpineJS enabled
{% endcomment %}

{% comment %} Check if approved customer {% endcomment %}
{% liquid
  assign is_approved_customer = false
  if customer and settings.account_matching_tags == blank
    assign is_approved_customer = true
  endif
  if customer.tags contains settings.account_matching_tags
    assign is_approved_customer = true
  endif
  if settings.account_match_b2b and customer.b2b?
    assign is_approved_customer = true
  endif
%}

{% capture product_standard_image %}
  <a 
    :href="`${item.url}`"
    class="
      animation-300 w-full overflow-clip hover:opacity-100
      {{ settings.product_card_color_scheme }} 
      {% if settings.product_card_border_style == 'image' %}
        border--radius
      {% endif %}
    ">
    <div class="overflow-clip object-cover
      {{ settings.product_card_ratio }}">
        {% capture crop %}
          {% if settings.product_card_crop == "cover" %}
            object-cover
          {% else %}
            object-contain
          {% endif %}
        {% endcapture %}
        <img 
          class="{{ crop }} h-full w-full"
          width="750"  
          height="750"
          loading="lazy"
          :src="`${ item.featured_image }&width=750`" 
          :alt="`${ item.title }`"/>
    </div>
  </a>
{% endcapture %}

{% capture product_title %}
  <h3 
    class="
      {{ settings.product_card_title_capitilization }}
      {{ settings.product_card_title_font }}
      {% if settings.product_card_alignment == "center" %}
        text-center
      {% endif %}
      {% if settings.product_card_alignment == "right" %}
        text-right
      {% endif %}
    "
    x-text="item.title">
  </h3>
{% endcapture %}

{% capture product_vendor %}
  {% if settings.product_card_enable_vendor %}
    <span 
      class="
        type--small
        {% if settings.product_card_alignment == "center" %}
          text-center
        {% endif %}
        {% if settings.product_card_alignment == "right" %}
          text-right
        {% endif %}
      "
      x-text="item.vendor">
    </span>
  {% endif %}
{% endcapture %}

{% capture product_type %}
  {% if settings.product_card_enable_type %}
    <span 
      class="
        type--small
        {% if settings.product_card_alignment == "center" %}
          text-center
        {% endif %}
        {% if settings.product_card_alignment == "right" %}
          text-right
        {% endif %}
      "
      x-text="item.type">
    </span>
  {% endif %}
{% endcapture %}

{% capture product_price %}
  {% if settings.product_card_show_prices %}
    <div 
      class="
        flex min-w-[33%] flex-wrap items-start gap-1
        {% if settings.product_card_alignment == "center" %}
          text-center justify-center
        {% endif %}
        {% if settings.product_card_alignment == "right" %}
          text-right justify-end
        {% endif %}
      "
      x-show="item.tags && !item.tags.includes('{{ settings.account_hide_price_tag }}')">

      {% comment %} Prices {% endcomment %}
      {% if settings.product_card_show_prices %}
        <div 
          class="shrink">
          <div 
            class="
              flex flex-wrap items-center gap-1
              {% if settings.product_card_alignment == "center" %}
                justify-center
              {% endif %}
              {% if settings.product_card_alignment == "right" or settings.product_card_alignment == "justified" %}
                justify-end
              {% endif %}
            ">

            {% comment %} Starting price {% endcomment %}
            <span>
              {% if settings.price_range == "show_starting_price" %}
                <span 
                  x-show="item.price_varies">
                  {{ 'labels.from' | t }}
                </span>
              {% endif %}
              <span 
                x-html="Shopify.formatMoney(item.price_min)">
              </span>
            </span>

            {% comment %} If showing range {% endcomment %}
            {% if settings.price_range == "show_range" %}
              <span 
                x-show="item.price_varies">- </span>
              <span 
                x-show="item.price_varies"
                x-html="Shopify.formatMoney(item.price_max)"></span>
            {% endif %}

            {% comment %} Sale price {% endcomment %}
            <span 
              class="opacity-50"
              x-show="item.compare_at_price_max > 0">
              <s 
                x-html="Shopify.formatMoney(item.compare_at_price_max)">
              </s>
            </span>

          </div>
        </div>
      {% endif %}
  

    </div>
  {% endif %}
{% endcapture %}

{% capture product_add %}
  <div 
    class="
      {% unless settings.enable_quick_mobile %}
        hidden md:block
      {% endunless %}
      {% unless settings.enable_quick_desktop %}
        md:hidden block
      {% endunless %}
    "
    x-show="item.tags && !item.tags.includes('{{ settings.account_hide_price_tag }}')">
    
    {% comment %} Adjust quantity {% endcomment %}
    <div 
      x-show="item.variants.length == 1">
      {% render 'template__variant-increment' %}
    </div>

    {% comment %} Open quick add overlay {% endcomment %}
    <button 
      class="btn btn--secondary !w-full"
      :class="{
        'btn--loading': button_loading
      }"
      type="button" 
      role="button"
      @click="
        button_loading = true; 
        fetchAndRenderQuickAdd(item.handle);
        setTimeout(function(){ button_loading = false}, 500);
      "
      x-show="item.variants.length > 1">
      <div 
        class="btn__content">
        {{ 'actions.add' | t }}
      </div>
      <div class="btn__spinner">
        {% render 'component__icon', icon: 'spinner', size: '24', class: '' %}
      </div>
    </button>

  </div>
{% endcapture %}

<div
  class="
    group/product relative flex h-full w-full flex-col
    {% if settings.product_card_border_style == 'thumbnail' %}
      border--radius overflow-clip
      {{ settings.product_card_color_border }}
      {{ settings.product_card_color_scheme }}
    {% endif %}
  "
  x-data="
    {
      button_loading: false
    }
  "
  {% if is_approved_customer == false %}
    x-show="!item.tags.includes('{{ settings.account_hide_product_tag }}')"
  {% endif %}
>
  {% comment %} Image {% endcomment %}
  <div
    class="
      focus-within:border--focus relative block w-full
      {% if settings.product_card_border_style == 'image' %}
        border--radius overflow-clip
        {{ settings.product_card_color_border }}
      {% endif %}
    "
  >
    {{ product_standard_image }}
  </div>

  {% comment %} Content {% endcomment %}
  <div
    class="
      flex grow flex-col items-start justify-between gap-4 whitespace-normal pt-2 no-underline hover:no-underline
      {% if settings.product_card_border_style == "thumbnail" %}
        p-4
      {% endif %}
    "
  >
    <div
      class="flex w-full grow flex-col gap-0.5"
    >
      {{ product_title }}
      {{ product_vendor }}
      {{ product_type }}
      {{ product_price }}
    </div>
    <div class="w-full">
      {{ product_add }}
    </div>
  </div>
</div>
