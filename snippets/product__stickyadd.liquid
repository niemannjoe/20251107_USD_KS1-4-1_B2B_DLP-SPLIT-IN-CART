<!-- snippets/product__stickyadd.liquid -->
{% comment %}
  This file is a stickybar that displays a fixed add to cart button on product pages.

  Accepts:
  - blocksettings: {object} Liquid object of block settings.

  Usage:
    {% render 'product__stickyadd',
      block: block
    %}

  Globals:
  - layout_horizontal: {string} Class string to set horizontal margin.
  - type_separator: {string} Settting to set divider as a dot or line.

  Recommendations:
  - This snippet only works on product pages.
{% endcomment %}

<div
  id="product-stickyadd"
  class="
    fixed z-30 w-auto

    {% if block.settings.position == "left" %}
      left-2 bottom-2 right-2 md:left-4 md:right-auto md:bottom-4 md:margin--gap shadow-md max-w-[500px] border--radius
    {% endif %}

    {% if block.settings.position == "right" %}
      right-2 left-2 bottom-2 md:left-auto md:right-4 md:bottom-4 md:margin--gap shadow-md max-w-[500px] border--radius
    {% endif %}

    {% if block.settings.position == "center" %}
      left-2 right-2 bottom-2 md:margin--gap !mx-auto shadow-md md:max-w-[70%] border--radius
    {% endif %}

    {% if block.settings.position == "full" %}
      left-0 bottom-0 w-full
    {% endif %}

    {{ block.settings.color_scheme }}
    {{ block.settings.color_border }}
  "
  x-ref="stickyadd"
  x-init="
    if (window.innerWidth <= 768) {
      {% if block.settings.position == 'full' %}
        sticky_bar_height_left = $refs.stickyadd.offsetHeight + {{ settings.type_base_size }};
        sticky_bar_height_right = $refs.stickyadd.offsetHeight + {{ settings.type_base_size }};
      {% else %}
        sticky_bar_height_left = $refs.stickyadd.offsetHeight + {{ settings.type_base_size  | times: 2 }};
        sticky_bar_height_right = $refs.stickyadd.offsetHeight + {{ settings.type_base_size  | times: 2 }};
      {% endif %}
    }
    else {
      {% case block.settings.position %}
        {% when 'left' %}
          sticky_bar_height_left = $refs.stickyadd.offsetHeight + {{ settings.type_base_size | times: 2 }};
        {% when 'right' %}
          sticky_bar_height_right = $refs.stickyadd.offsetHeight + {{ settings.type_base_size | times: 2 }};
        {% when 'full' %}
          sticky_bar_height_left = $refs.stickyadd.offsetHeight;
          sticky_bar_height_right = $refs.stickyadd.offsetHeight;
      {% endcase %}
    }
  "
  {% if block.settings.on_scroll %}
    x-show="stickyadd"
    {% if settings.enable_animations %}
      x-transition:enter="animation-300"
      x-transition:enter-start="opacity-0 translate-y-8"
      x-transition:enter-end="opacity-100"
      x-transition:leave="animation-300"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0 translate-y-8"
    {% endif %}
    x-cloak
  {% endif %}
>
  <div class="{{ settings.x_margin }} p-4 md:p-6">
    <div
      class="flex flex-row flex-wrap items-center justify-between gap-4"
    >
      {% comment %} Title and text {% endcomment %}
      <div
        class="
          hidden w-full flex-col gap-2 md:flex md:w-auto
          {% if block.settings.position == "full" %}
            md:w-auto
          {% endif %}
        "
      >
        <h3 class="type__heading type--big">
          <span class="type__heading type--big">{{ product.title }}</span>
        </h3>
        {% unless block.settings.content == blank %}
          <div class="hidden md:block">
            {{ block.settings.content }}
          </div>
        {% endunless %}
      </div>

      {% comment %} Action and options {% endcomment %}
      <div
        class="flex w-full flex-col gap-4 md:w-auto md:flex-row"
      >
        {% comment %} Options {% endcomment %}
        {% unless product.has_only_default_variant %}
          <div
            class="inline-flex text-left"
            x-show="all_options_selected"
          >
            <button
              class="border__input--radius border__input color__border-input color__bg-input color__input border--input-padding hover:border__input--hover focus:border__input--focus relative w-full min-w-[256px] cursor-pointer appearance-none px-4 py-2"
              type="button"
              @click="
                                document.getElementById('js-options-' + '{{ section.id }}' + '-' + '{{ product.id }}').scrollIntoView();
              "
            >
              {% comment %} Text and swatch {% endcomment %}
              {% for variant in product.variants %}
                <span
                  class="bottom-0 left-2 top-0 flex h-full max-w-[70%] items-center gap-4 truncate"
                  x-show="current_variant_id == {{ variant.id}}"
                  x-cloak
                >
                  {% comment %} Text {% endcomment %}
                  {{ variant.title }}
                </span>
              {% endfor %}

              {% comment %} Chevron icon {% endcomment %}
              <div class="absolute bottom-0 right-4 top-0 flex h-full items-center">
                {% render 'component__icon', icon: 'chevron-down', size: '20' %}
              </div>
            </button>
          </div>
        {% endunless %}

        {% comment %} Actions {% endcomment %}
        <div
          class="w-full grow"
        >
          {% comment %} Choose options, if non selected {% endcomment %}
          <button
            class="btn btn--load btn--plain !w-full"
            :class="{ 'btn--loading' : cart_loading && button_loading }"
            type="button"
            role="button"
            disabled
            :disabled="button_loading"
            @click="
              failed_clicked = true;
              document.getElementById('js-options-' + '{{ section.id }}' + '-' + '{{ product.id }}').scrollIntoView();
            "
            x-show="!all_options_selected"
            x-cloak
          >
            <div class="btn__content">
              {{ 'actions.choose_options' | t }}
            </div>
          </button>

          {% comment %} Sold out, if selected option unavailable {% endcomment %}
          <button
            class="btn btn--load btn--plain !w-full"
            :class="{ 'btn--loading' : cart_loading && button_loading }"
            type="button"
            role="button"
            disabled
            :disabled="button_loading"
            x-show="!current_variant_available && current_variant_exists && all_options_selected"
            x-cloak
          >
            <div class="btn__content">
              {{ 'labels.sold_out' | t }}
            </div>
          </button>

          {% comment %} Unavailable, if selected option unavailable {% endcomment %}
          <button
            class="btn btn--load btn--plain !w-full"
            :class="{ 'btn--loading' : cart_loading && button_loading }"
            type="button"
            role="button"
            disabled
            :disabled="button_loading"
            x-show="!current_variant_exists && all_options_selected"
            x-cloak
          >
            <div class="btn__content">
              {{ 'labels.unavailable' | t }}
            </div>
          </button>

          {% comment %} Add to cart {% endcomment %}
          <button
            class="btn btn--load !w-full {{ block.settings.color_button }}"
            type="submit"
            role="button"
            :class="{ 'btn--loading' : cart_loading && button_loading }"
            :disabled="button_loading"
            x-show="current_variant_exists && current_variant_available && all_options_selected"
          >
            <div class="btn__content">
              {% if product.metafields.custom.button_text %}
                {{ product.metafields.custom.button_text }}
                {% if settings.type_separator == 'dot' %}·{% else %}|{% endif %}
              {% else %}
                {{ 'actions.add' | t }}
                {% if settings.show_button_prices %}
                  {% if settings.type_separator == 'dot' %}·{% else %}|{% endif %}
                {% endif %}
              {% endif %}

              {% capture product_price %}
                <span class="ml-1" 
                  x-html="Shopify.formatMoney(calculated_price)">
                  {% render 'component__format-price', price: product.price %}
                </span>
              {% endcapture %}
              {% if settings.show_button_prices %}
                {{ product_price }}
              {% endif %}
            </div>
            <div class="btn__spinner">
              {% render 'component__icon', icon: 'spinner', size: '24', class: '' %}
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
